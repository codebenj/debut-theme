<?php
use Illuminate\Support\Arr;
//activate
if (! function_exists('activate_quantity_breaks_addon')) {
    function activate_quantity_breaks_addon($StoreThemes, $shop) {
      	foreach ($StoreThemes as $theme) {

            // add section
            try{
                $section = (string) '{%- comment -%}Please do not edit this file. Any modification can be lost as it is automatically updated by Debutify{%- endcomment -%}
                {%- if section.settings.dbtfy_quantity_breaks and section.blocks.size > 0 -%}
                <div class="qb-wrapper"
                     data-save-text="{{ "products.general.save_html" | t: saved_amount: discount_saved }}"
                     data-save-after-percentage-text="{{ section.settings.dbtfy_quantity_breaks_saved_money_text_after_percentage }}"
                     data-more-discount-before-quantity-text="{{ section.settings.dbtfy_quantity_breaks_more_discount_text_before }}"
                     data-more-discount-after-quantity-text="{{ section.settings.dbtfy_quantity_breaks_more_discount_text_after }}"
                     data-more-discount-after-percentage-text="{{ section.settings.dbtfy_quantity_breaks_more_discount_text_after_percentage }}"
                     data-saved-money="{{ section.settings.dbtfy_quantity_breaks_saved_money }}"
                     data-before-coupon-code="{{ section.settings.dbtfy_quantity_breaks_coupon_code_text_before }}"
                     data-after-coupon-code="{{ section.settings.dbtfy_quantity_breaks_coupon_code_text_after }}"
                     data-highest-discount-text="{{ section.settings.dbtfy_quantity_breaks_highest_discount_text }}"
                     data-quantity-label="{{ section.settings.dbtfy_quantity_label }}">
                  <div id="QuantityBreaks" class="dbtfy dbtfy-quantity_breaks"
                       data-product-id="{{ product.id }}"
                       data-section-id="{{ section.id }}"
                       data-section-type="quantity-breaks">
                    {%- if section.settings.dbtfy_quantity_breaks_text != blank -%}
                    <p class="qb-label"><small>{{ section.settings.dbtfy_quantity_breaks_text }}</small></p>
                    {%- endif -%}
                    <div class="product-single__quantity product-form__item">
                      <div class="qb-quantity">
                        <input type="radio" id="Quantity1" name="quantity" value="1" checked>
                        <label for="Quantity1">{{ section.settings.dbtfy_quantity_breaks_buy }} 1 {{ section.settings.additional_text }} {{ section.settings.separator_text }} <span class="qb-price"></span></label>
                      </div>
                      {%- for block in section.blocks -%}
                      {%- if block.settings.dbtfy_quantity_breaks_discount != "" and block.settings.dbtfy_quantity_breaks_code != "" -%}
                      <div class="qb-quantity qb-quantity-range">
                        <input type="radio" id="Quantity-{{block.id}}" name="quantity" value="{{ block.settings.dbtfy_quantity_breaks_range }}"
                               data-discount="{{ block.settings.dbtfy_quantity_breaks_discount }}"
                               data-discount-code="{{ block.settings.dbtfy_quantity_breaks_code }}">
                        <label for="Quantity-{{block.id}}">
                          {{ section.settings.dbtfy_quantity_breaks_buy }} {{ block.settings.dbtfy_quantity_breaks_range }} {{ block.settings.additional_text }} {{ section.settings.separator_text }} <span class="qb-price"></span>
                        </label>
                      </div>
                      {%- endif -%}
                      {%- endfor -%}
                    </div>
                  </div>
                </div>
                {%- endif -%}

                ';
                $section_schema = (string) '{%- schema -%}
                  {
                    "name": "Quantity breaks",
                      "settings": [
                      {
                        "type": "header",
                        "content": "Activation"
                      },
                        {
                        "type": "checkbox",
                        "id": "dbtfy_quantity_breaks",
                        "label": "Activate",
                        "default": false
                      },
                      {
                        "type": "header",
                        "content": "Product page text"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_label",
                        "label": "Quantity label",
                            "default": "Quantity"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_text",
                        "label": "Quantity breaks text"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_buy",
                        "label": "Buy text",
                        "default": "Buy"
                      },
                      {
                        "type": "text",
                        "id": "additional_text",
                        "label": "Additional text for priceline"
                      },
                      {
                        "type": "text",
                        "id": "separator_text",
                        "label": "Separator text",
                        "default": "-"
                      },
                        {
                        "type": "header",
                        "content": "Cart text"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_saved_money",
                        "label": "Text before amount saved",
                        "default": "You are saving"
                      },
                      {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_saved_money_text_after_percentage",
                        "label": "Text after discount percentage",
                        "default": "off"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_coupon_code_text_before",
                        "label": "Text before discount code",
                        "default": "Coupon code"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_coupon_code_text_after",
                        "label": "Text after discount code",
                        "default": "applied at checkout"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_more_discount_text_before",
                        "label": "Text before quantity",
                        "default": "Add"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_more_discount_text_after",
                        "label": "Text after quantity",
                        "default": "more item to unlock"
                      },
                      {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_more_discount_text_after_percentage",
                        "label": "Text after discount percentage",
                        "default": "off"
                      },
                        {
                        "type": "text",
                        "id": "dbtfy_quantity_breaks_highest_discount_text",
                        "label": "Highest discount text",
                        "default": "Highest discount applied!"
                      }
                      ],
                    "blocks" : [
                      {
                        "type": "discount",
                        "name": "Quantity break",
                            "limit": 5,
                        "settings": [
                          {
                            "type": "range",
                            "id": "dbtfy_quantity_breaks_range",
                                  "label": "Quantity",
                            "min": 2,
                            "max": 20,
                            "step": 1,
                                  "default": 2,
                                  "info": "Set the same \"Minimum quantity of items\" in your discount code settings"
                          },
                          {
                            "type": "text",
                            "id": "dbtfy_quantity_breaks_code",
                            "label": "Discount code",
                            "info": "[Create a percentage discount code](\/admin\/discounts\/new)",
                            "placeholder": "10OFFDISCOUNT"
                          },
                          {
                            "type": "text",
                            "id": "dbtfy_quantity_breaks_discount",
                            "label": "Discount value %",
                            "placeholder": "10"
                          },
                          {
                            "type": "text",
                            "id": "additional_text",
                            "label": "Additional text for priceline"
                          }
                            ]
                      }
                    ]
                  }
                {%- endschema -%}';

                $section = addScriptTagCondition($shop, '{%- comment -%}Please do not edit this file. Any modification can be lost as it is automatically updated by Debutify{%- endcomment -%}', $section);

                $section .= $section_schema;

                $create_quantity_breaks_section = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'sections/dbtfy-quantity-breaks.liquid', 'value' => $section] ]
                );
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('add quantity breaks throws client exception');
            }
            catch(\Exception $e){
                logger('add quantity breaks throws exception');
            }

            // add scss
            try{
                $styles = (string) '/* start-dbtfy-quantity-breaks */.dbtfy-quantity_breaks{.qb-label{margin-top:-$spacer/2;margin-bottom:$spacer-xs}.qb-quantity{margin-bottom:$spacer-xs}.qb-alert{background-color:$colorDefault;padding:$spacer-sm;margin-bottom:$spacer;text-align:center;border-radius:$borderRadius;#CartDrawer &{color:$colorDrawerText;background-color:$colorDrawerDefault}}.qb-text,.qb-saved-text,.qb-highest-discount-text{strong{color:$colorSale;#CartDrawer &{color:$colorDrawerPrimary}}}.qb-saved-amount{@include accentFontStack;text-transform:uppercase;font-size:$baseFontSize-sm;background-color:$colorSale;color:$colorButtonText;padding:$spacer-xs;border-radius:$borderRadius;margin-left:$spacer-xs;vertical-align:text-top;white-space:nowrap}}.qb-original-price{text-decoration:line-through;margin-right:$spacer-xs;@include accentFontStack}.qb-discounted-price{color:$colorSale;font-weight:$accentFontWeight;#CartDrawer &{color:$colorDrawerPrimary}}.qb-wrapper{display:none}.quantity-break-label{display:block;margin-bottom:$spacer-xs}/* end-dbtfy-quantity-breaks */';

                $theme_style_content = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/theme.scss.liquid'] ]
                )['body']['asset']['value'] ?? '';

                if( ( $pos = strpos( $theme_style_content , 'start-dbtfy-quantity-breaks' ) ) === false ) {
                    $new_theme_styles = str_replace($theme_style_content, $theme_style_content.$styles, $theme_style_content);
                    $add_styles = $shop->api()->request(
                        'PUT',
                        '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                        ['asset' => ['key' => 'assets/theme.scss.liquid', 'value' => $new_theme_styles] ]
                    );
                }
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('update CSS on quantity breaks addon throws client exception');
            }
            catch(\Exception $e){
                logger('update CSS on quantity breaks addon throws exception');
            }

            // add include
            try{
                $product_template = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'layout/theme.liquid'] ]
                )['body']['asset']['value'] ?? '';

                if( ( $pos = strpos( $product_template , 'dbtfy-quantity-breaks' ) ) === false ) {
                    if( ( $pos = strrpos( $product_template , '</body>' ) ) !== false ) {
                        $new_prod_template = str_replace('</body>', '{% section "dbtfy-quantity-breaks" %} </body>', $product_template);
                        $update_prod_template = $shop->api()->request(
                            'PUT',
                            '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                            ['asset' => ['key' => 'layout/theme.liquid', 'value' => $new_prod_template] ]
                        );
                    }
                }
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('update theme on quantity breaks addon throws client exception');
            }
            catch(\Exception $e){
                logger('update theme on quantity breaks addon throws exception');
            }

            // add js addon
            try{
              $script= (string)'/* start-dbtfy-quantity-breaks */ function themeQuantityBreaks() { var _0xa4ab=["\x2E\x70\x72\x6F\x64\x75\x63\x74\x2D\x73\x69\x6E\x67\x6C\x65\x5F\x5F\x66\x6F\x72\x6D\x20\x2E\x70\x72\x6F\x64\x75\x63\x74\x2D\x73\x69\x6E\x67\x6C\x65\x5F\x5F\x71\x75\x61\x6E\x74\x69\x74\x79","\x2E\x70\x72\x6F\x64\x75\x63\x74\x2D\x73\x69\x6E\x67\x6C\x65\x5F\x5F\x66\x6F\x72\x6D\x20\x2E\x70\x72\x6F\x64\x75\x63\x74\x2D\x73\x69\x6E\x67\x6C\x65\x5F\x5F\x61\x64\x64\x2D\x74\x6F\x2D\x63\x61\x72\x74","\x2E\x71\x62\x2D\x77\x72\x61\x70\x70\x65\x72","\x68\x74\x6D\x6C","\x64\x61\x74\x61\x2D\x71\x75\x61\x6E\x74\x69\x74\x79\x2D\x6C\x61\x62\x65\x6C","\x61\x74\x74\x72","\x2E\x70\x72\x6F\x64\x75\x63\x74\x2D\x73\x69\x6E\x67\x6C\x65\x5F\x5F\x76\x61\x72\x69\x61\x6E\x74\x73","\x6D\x6F\x6E\x65\x79\x46\x6F\x72\x6D\x61\x74","\x73\x74\x72\x69\x6E\x67\x73","\x6C\x65\x6E\x67\x74\x68","","\x2E\x61\x6A\x61\x78\x63\x61\x72\x74\x5F\x5F\x70\x72\x6F\x64\x75\x63\x74\x3A\x66\x69\x72\x73\x74","\x2E\x75\x70\x64\x61\x74\x65\x2D\x63\x61\x72\x74","\x64\x61\x74\x61\x2D\x6D\x6F\x72\x65\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74\x2D\x62\x65\x66\x6F\x72\x65\x2D\x71\x75\x61\x6E\x74\x69\x74\x79\x2D\x74\x65\x78\x74","\x64\x61\x74\x61\x2D\x6D\x6F\x72\x65\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74\x2D\x61\x66\x74\x65\x72\x2D\x71\x75\x61\x6E\x74\x69\x74\x79\x2D\x74\x65\x78\x74","\x64\x61\x74\x61\x2D\x6D\x6F\x72\x65\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74\x2D\x61\x66\x74\x65\x72\x2D\x70\x65\x72\x63\x65\x6E\x74\x61\x67\x65\x2D\x74\x65\x78\x74","\x64\x61\x74\x61\x2D\x73\x61\x76\x65\x64\x2D\x6D\x6F\x6E\x65\x79","\x64\x61\x74\x61\x2D\x73\x61\x76\x65\x2D\x61\x66\x74\x65\x72\x2D\x70\x65\x72\x63\x65\x6E\x74\x61\x67\x65\x2D\x74\x65\x78\x74","\x64\x61\x74\x61\x2D\x62\x65\x66\x6F\x72\x65\x2D\x63\x6F\x75\x70\x6F\x6E\x2D\x63\x6F\x64\x65","\x64\x61\x74\x61\x2D\x61\x66\x74\x65\x72\x2D\x63\x6F\x75\x70\x6F\x6E\x2D\x63\x6F\x64\x65","\x64\x61\x74\x61\x2D\x68\x69\x67\x68\x65\x73\x74\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74\x2D\x74\x65\x78\x74","\x2E\x61\x6A\x61\x78\x63\x61\x72\x74\x5F\x5F\x73\x75\x62\x74\x6F\x74\x61\x6C\x3A\x6C\x61\x73\x74","\x2E\x63\x61\x72\x74\x5F\x5F\x73\x75\x62\x74\x6F\x74\x61\x6C\x3A\x6C\x61\x73\x74","\x2E\x69\x6E\x70\x75\x74\x2D\x63\x61\x72\x74\x5F\x64\x69\x73\x63\x6F\x75\x6E\x74","\x2E\x71\x62\x2D\x61\x6C\x65\x72\x74\x2D\x77\x72\x61\x70\x70\x65\x72","\x69\x74\x65\x6D\x5F\x63\x6F\x75\x6E\x74","\x69\x6E\x70\x75\x74\x5B\x6E\x61\x6D\x65\x3D\x27\x71\x75\x61\x6E\x74\x69\x74\x79\x27\x5D","\x66\x69\x6E\x64","\x76\x61\x6C","\x64\x61\x74\x61\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74","\x64\x61\x74\x61\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74\x2D\x63\x6F\x64\x65","\x65\x61\x63\x68","\x2E\x71\x62\x2D\x71\x75\x61\x6E\x74\x69\x74\x79\x2D\x72\x61\x6E\x67\x65","\x69\x74\x65\x6D\x73\x5F\x73\x75\x62\x74\x6F\x74\x61\x6C\x5F\x70\x72\x69\x63\x65","\x3C\x64\x69\x76\x20\x63\x6C\x61\x73\x73\x3D\x27\x64\x62\x74\x66\x79\x20\x64\x62\x74\x66\x79\x2D\x71\x75\x61\x6E\x74\x69\x74\x79\x5F\x62\x72\x65\x61\x6B\x73\x27\x3E\x3C\x64\x69\x76\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x62\x2D\x61\x6C\x65\x72\x74\x27\x3E","\x3C\x64\x69\x76\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x62\x2D\x73\x61\x76\x65\x64\x2D\x74\x65\x78\x74\x27\x3E\x3C\x73\x70\x61\x6E\x20\x63\x6C\x61\x73\x73\x3D\x27\x66\x61\x20\x66\x61\x2D\x74\x61\x67\x27\x3E\x3C\x2F\x73\x70\x61\x6E\x3E\x20","\x20\x3C\x73\x74\x72\x6F\x6E\x67\x3E","\x66\x6F\x72\x6D\x61\x74\x4D\x6F\x6E\x65\x79","\x43\x75\x72\x72\x65\x6E\x63\x79","\x3C\x2F\x73\x74\x72\x6F\x6E\x67\x3E\x20\x28","\x72\x6F\x75\x6E\x64","\x25\x20","\x29\x3C\x2F\x64\x69\x76\x3E","\x3C\x64\x69\x76\x3E\x3C\x73\x6D\x61\x6C\x6C\x3E","\x20\x22","\x22\x20","\x3C\x2F\x73\x6D\x61\x6C\x6C\x3E\x3C\x2F\x64\x69\x76\x3E","\x3C\x64\x69\x76\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x62\x2D\x74\x65\x78\x74\x27\x3E","\x3C\x2F\x73\x74\x72\x6F\x6E\x67\x3E\x20","\x25\x3C\x2F\x73\x74\x72\x6F\x6E\x67\x3E\x20","\x3C\x2F\x64\x69\x76\x3E","\x3C\x64\x69\x76\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x62\x2D\x68\x69\x67\x68\x65\x73\x74\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74\x2D\x74\x65\x78\x74\x27\x3E","\x3C\x2F\x64\x69\x76\x3E\x3C\x2F\x64\x69\x76\x3E","\x71\x62\x2D\x61\x6C\x65\x72\x74\x2D\x64\x72\x61\x77\x65\x72\x2D\x77\x72\x61\x70\x70\x65\x72","\x61\x64\x64\x43\x6C\x61\x73\x73","\x69\x6E\x73\x65\x72\x74\x42\x65\x66\x6F\x72\x65","\x71\x62\x2D\x61\x6C\x65\x72\x74\x2D\x77\x72\x61\x70\x70\x65\x72","\x2E\x63\x61\x72\x74\x5F\x5F\x63\x68\x65\x63\x6B\x6F\x75\x74","\x3C\x69\x6E\x70\x75\x74\x20\x74\x79\x70\x65\x3D\x27\x68\x69\x64\x64\x65\x6E\x27\x20\x6E\x61\x6D\x65\x3D\x27\x64\x69\x73\x63\x6F\x75\x6E\x74\x27\x20\x63\x6C\x61\x73\x73\x3D\x27\x69\x6E\x70\x75\x74\x2D\x63\x61\x72\x74\x5F\x64\x69\x73\x63\x6F\x75\x6E\x74\x27\x20\x76\x61\x6C\x75\x65\x3D\x27","\x27\x3E","\x3C\x73\x70\x61\x6E\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x62\x2D\x6F\x72\x69\x67\x69\x6E\x61\x6C\x2D\x70\x72\x69\x63\x65\x27\x3E","\x3C\x2F\x73\x70\x61\x6E\x3E\x3C\x73\x70\x61\x6E\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x62\x2D\x64\x69\x73\x63\x6F\x75\x6E\x74\x65\x64\x2D\x70\x72\x69\x63\x65\x27\x3E","\x3C\x2F\x73\x70\x61\x6E\x3E","\x3C\x73\x70\x61\x6E\x3E","\x2E\x71\x74\x79\x2D\x63\x6F\x6E\x74\x61\x69\x6E\x65\x72","\x64\x61\x74\x61\x2D\x73\x65\x63\x74\x69\x6F\x6E\x2D\x69\x64","\x64\x69\x76\x5B\x64\x61\x74\x61\x2D\x73\x65\x63\x74\x69\x6F\x6E\x2D\x74\x79\x70\x65\x3D\x27\x70\x72\x6F\x64\x75\x63\x74\x2D\x74\x65\x6D\x70\x6C\x61\x74\x65\x27\x5D","\x63\x6C\x6F\x73\x65\x73\x74","\x23\x50\x72\x6F\x64\x75\x63\x74\x4A\x73\x6F\x6E\x2D","\x69\x6E\x6E\x65\x72\x48\x54\x4D\x4C","\x50\x72\x6F\x64\x75\x63\x74\x4A\x73\x6F\x6E\x2D","\x67\x65\x74\x45\x6C\x65\x6D\x65\x6E\x74\x42\x79\x49\x64","\x70\x61\x72\x73\x65","\x3C\x64\x69\x76\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x74\x79\x2D\x63\x6F\x6E\x74\x61\x69\x6E\x65\x72\x27\x3E\x3C\x2F\x64\x69\x76\x3E","\x3C\x6C\x61\x62\x65\x6C\x20\x66\x6F\x72\x3D\x27\x51\x75\x61\x6E\x74\x69\x74\x79\x27\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x75\x61\x6E\x74\x69\x74\x79\x2D\x62\x72\x65\x61\x6B\x2D\x6C\x61\x62\x65\x6C\x27\x3E","\x3C\x2F\x6C\x61\x62\x65\x6C\x3E","\x63\x68\x61\x6E\x67\x65","\x2E\x70\x72\x6F\x64\x75\x63\x74\x2D\x64\x65\x74\x61\x69\x6C\x73\x20\x2E\x70\x72\x6F\x64\x75\x63\x74\x2D\x73\x69\x6E\x67\x6C\x65\x5F\x5F\x71\x75\x61\x6E\x74\x69\x74\x79","\x2E\x71\x62\x2D\x71\x75\x61\x6E\x74\x69\x74\x79","\x23\x50\x72\x6F\x64\x75\x63\x74\x53\x65\x6C\x65\x63\x74","\x76\x61\x72\x69\x61\x6E\x74\x73","\x69\x64","\x70\x72\x69\x63\x65","\x63\x6F\x6D\x70\x61\x72\x65\x5F\x61\x74\x5F\x70\x72\x69\x63\x65","\x2E\x71\x62\x2D\x70\x72\x69\x63\x65","\x64\x61\x74\x61\x2D\x73\x61\x76\x65\x2D\x74\x65\x78\x74","\x73\x68\x6F\x77","\x25","\x3C\x2F\x73\x70\x61\x6E\x3E\x20\x3C\x73\x70\x61\x6E\x20\x63\x6C\x61\x73\x73\x3D\x27\x71\x62\x2D\x73\x61\x76\x65\x64\x2D\x61\x6D\x6F\x75\x6E\x74\x27\x3E","\x20","\x68\x69\x64\x65","\x6F\x6E","\x61\x6A\x61\x78\x43\x61\x72\x74\x2E\x61\x66\x74\x65\x72\x43\x61\x72\x74\x4C\x6F\x61\x64","\x62\x6F\x64\x79","\x74\x65\x6D\x70\x6C\x61\x74\x65\x2D\x63\x61\x72\x74","\x68\x61\x73\x43\x6C\x61\x73\x73","\x47\x45\x54","\x2F\x63\x61\x72\x74\x2E\x6A\x73","\x6A\x73\x6F\x6E","\x61\x6A\x61\x78","\x74\x72\x69\x67\x67\x65\x72"];function QuantityBreaks(){var _0x6937x2=$(_0xa4ab[0]),_0x6937x3=$(_0xa4ab[1]),_0x6937x4=$(_0xa4ab[2]),_0x6937x5=_0x6937x4[_0xa4ab[3]](),_0x6937x6=_0x6937x4[_0xa4ab[5]](_0xa4ab[4]),_0x6937x7=$(_0xa4ab[6]),_0x6937x8=theme[_0xa4ab[8]][_0xa4ab[7]],_0x6937x9=[];if(!_0x6937x4[_0xa4ab[9]]){return !1};function _0x6937xa(_0x6937xa){var _0x6937x5=0,_0x6937x6=0,_0x6937x7=0,_0x6937x9=0,_0x6937xb=_0xa4ab[10],_0x6937x2=0,_0x6937x3=0,_0x6937xc=_0xa4ab[10],_0x6937xd=0,_0x6937xe=$(_0xa4ab[11]),_0x6937xf=$(_0xa4ab[12]),_0x6937x10=_0x6937x4[_0xa4ab[5]](_0xa4ab[13]),_0x6937x11=_0x6937x4[_0xa4ab[5]](_0xa4ab[14]),_0x6937x12=_0x6937x4[_0xa4ab[5]](_0xa4ab[15]),_0x6937x13=_0x6937x4[_0xa4ab[5]](_0xa4ab[16]),_0x6937x14=_0x6937x4[_0xa4ab[5]](_0xa4ab[17]),_0x6937x15=_0x6937x4[_0xa4ab[5]](_0xa4ab[18]),_0x6937x16=_0x6937x4[_0xa4ab[5]](_0xa4ab[19]),_0x6937x17=_0x6937x4[_0xa4ab[5]](_0xa4ab[20]),_0x6937x18=$(_0xa4ab[21]),_0x6937x19=$(_0xa4ab[22]),_0x6937x1a=$(_0xa4ab[23]),_0x6937x1b=$(_0xa4ab[24]);_0x6937xa[_0xa4ab[25]]&& (_0x6937x4[_0xa4ab[27]](_0xa4ab[32])[_0xa4ab[31]](function(_0x6937x2){var _0x6937x3=$(this)[_0xa4ab[27]](_0xa4ab[26]);if(_0x6937x7= parseInt(_0x6937x3[_0xa4ab[28]]()),0< _0x6937x2&& 0,_0x6937xa[_0xa4ab[25]]>= _0x6937x7&& (_0x6937x9= parseInt(_0x6937x3[_0xa4ab[5]](_0xa4ab[29])),_0x6937xb= _0x6937x3[_0xa4ab[5]](_0xa4ab[30])),!_0x6937x5&& _0x6937xa[_0xa4ab[25]]< _0x6937x7){return _0x6937x5= _0x6937x7- _0x6937xa[_0xa4ab[25]],_0x6937x6= parseInt(_0x6937x3[_0xa4ab[5]](_0xa4ab[29])),!1}}),_0x6937x2= _0x6937xa[_0xa4ab[33]]* _0x6937x9/ 100,_0x6937x3= _0x6937xa[_0xa4ab[33]]- _0x6937x2,_0x6937xd= 100* _0x6937x2/ _0x6937xa[_0xa4ab[33]],_0x6937xc= _0xa4ab[34],0< _0x6937x2&& _0x6937x13&& (_0x6937xc+= _0xa4ab[35]+ _0x6937x13+ _0xa4ab[36]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937x2,_0x6937x8)+ _0xa4ab[39]+ Math[_0xa4ab[40]](_0x6937xd)+ _0xa4ab[41]+ _0x6937x14+ _0xa4ab[42]),_0x6937xb&& (_0x6937x15|| _0x6937x16)&& (_0x6937xc+= _0xa4ab[43]+ _0x6937x15+ _0xa4ab[44]+ _0x6937xb+ _0xa4ab[45]+ _0x6937x16+ _0xa4ab[46]),_0x6937x5?(_0x6937x10|| _0x6937x11|| _0x6937x12)&& (_0x6937xc+= _0xa4ab[47]+ _0x6937x10+ _0xa4ab[36]+ _0x6937x5+ _0xa4ab[48]+ _0x6937x11+ _0xa4ab[36]+ _0x6937x6+ _0xa4ab[49]+ _0x6937x12+ _0xa4ab[50]):_0x6937x17&& (_0x6937xc+= _0xa4ab[51]+ _0x6937x17+ _0xa4ab[50]),_0x6937xc+= _0xa4ab[52],$(_0x6937xc)[_0xa4ab[55]](_0x6937xe)[_0xa4ab[54]](_0xa4ab[53]),_0x6937x1b[_0xa4ab[9]]?_0x6937x1b[_0xa4ab[3]](_0x6937xc):$(_0x6937xc)[_0xa4ab[55]](_0x6937xf)[_0xa4ab[54]](_0xa4ab[56]),_0x6937x1a[_0xa4ab[9]]?_0x6937x1a[_0xa4ab[28]](_0x6937xb):$(_0xa4ab[58]+ _0x6937xb+ _0xa4ab[59])[_0xa4ab[55]](_0xa4ab[57]),_0x6937x3< _0x6937xa[_0xa4ab[33]]?(_0x6937x18[_0xa4ab[3]](_0xa4ab[60]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xa[_0xa4ab[33]],_0x6937x8)+ _0xa4ab[61]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937x3,_0x6937x8)+ _0xa4ab[62]),_0x6937x19[_0xa4ab[3]](_0xa4ab[60]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xa[_0xa4ab[33]],_0x6937x8)+ _0xa4ab[61]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937x3,_0x6937x8)+ _0xa4ab[62])):(_0x6937x18[_0xa4ab[3]](_0xa4ab[63]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xa[_0xa4ab[33]],_0x6937x8)+ _0xa4ab[62]),_0x6937x19[_0xa4ab[3]](_0xa4ab[63]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xa[_0xa4ab[33]],_0x6937x8)+ _0xa4ab[62])))}_0x6937x2[_0xa4ab[9]]?_0x6937x2[_0xa4ab[31]](function(){var _0x6937x2=$(this),_0x6937x3=_0x6937x2[_0xa4ab[27]](_0xa4ab[64]),_0x6937xa=_0x6937x2[_0xa4ab[67]](_0xa4ab[66])[_0xa4ab[5]](_0xa4ab[65]);$(_0xa4ab[68]+ _0x6937xa)[_0xa4ab[9]]&& (_0x6937x3[_0xa4ab[3]](_0x6937x5),_0x6937x9[_0x6937xa]= JSON[_0xa4ab[72]](document[_0xa4ab[71]](_0xa4ab[70]+ _0x6937xa)[_0xa4ab[69]]))}):_0x6937x3[_0xa4ab[31]](function(){var _0x6937x2=$(this),_0x6937x3=$(_0xa4ab[73])[_0xa4ab[55]](_0x6937x2),_0x6937xa=_0x6937x2[_0xa4ab[67]](_0xa4ab[66])[_0xa4ab[5]](_0xa4ab[65]);$(_0xa4ab[68]+ _0x6937xa)[_0xa4ab[9]]&& (_0x6937x3[_0xa4ab[3]](_0xa4ab[74]+ _0x6937x6+ _0xa4ab[75]+ _0x6937x5),_0x6937x9[_0x6937xa]= JSON[_0xa4ab[72]](document[_0xa4ab[71]](_0xa4ab[70]+ _0x6937xa)[_0xa4ab[69]]))}),$(document)[_0xa4ab[91]](_0xa4ab[76],_0x6937x7,function(){var _0x6937xb,_0x6937xc,_0x6937xd=0,_0x6937xe=0,_0x6937xf=$(_0xa4ab[77]),_0x6937x2=_0x6937x7[_0xa4ab[67]](_0xa4ab[66]),_0x6937x3=_0x6937x2[_0xa4ab[5]](_0xa4ab[65]),_0x6937xa=_0x6937x2[_0xa4ab[27]](_0xa4ab[78]),_0x6937x5=_0x6937x2[_0xa4ab[27]](_0xa4ab[79])[_0xa4ab[28]](),_0x6937x6=_0x6937x9[_0x6937x3][_0xa4ab[80]];$[_0xa4ab[31]](_0x6937x6,function(){_0x6937x5== this[_0xa4ab[81]]&& (_0x6937xd= this[_0xa4ab[82]],_0x6937xe= this[_0xa4ab[83]])}),_0x6937xa[_0xa4ab[31]](function(){var _0x6937x2=$(this),_0x6937x3=_0x6937x2[_0xa4ab[27]](_0xa4ab[26]),_0x6937xa=_0x6937x3[_0xa4ab[28]](),_0x6937x5=_0x6937x3[_0xa4ab[5]](_0xa4ab[29]),_0x6937x6=_0x6937x2[_0xa4ab[27]](_0xa4ab[84]),_0x6937x7=_0x6937x4[_0xa4ab[5]](_0xa4ab[85]),_0x6937x9=0;_0x6937xd?(_0x6937xf[_0xa4ab[86]](),void(0)!== _0x6937x5?(_0x6937xb= _0x6937xa* _0x6937xd,_0x6937x9= _0x6937xd* parseInt(_0x6937x5)/ 100,_0x6937xc= _0x6937xd- _0x6937x9,_0x6937xc*= _0x6937xa,_0x6937x9= Math[_0xa4ab[40]](_0x6937x5)+ _0xa4ab[87],_0x6937x6[_0xa4ab[3]](_0xa4ab[60]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xb,_0x6937x8)+ _0xa4ab[61]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xc,_0x6937x8)+ _0xa4ab[88]+ _0x6937x7+ _0xa4ab[89]+ _0x6937x9+ _0xa4ab[62])):_0x6937xe?_0x6937x6[_0xa4ab[3]](_0xa4ab[60]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xe,_0x6937x8)+ _0xa4ab[61]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xd,_0x6937x8)+ _0xa4ab[63]):_0x6937x6[_0xa4ab[3]](_0xa4ab[63]+ theme[_0xa4ab[38]][_0xa4ab[37]](_0x6937xd,_0x6937x8)+ _0xa4ab[63])):_0x6937xf[_0xa4ab[90]]()})}),$(_0xa4ab[93])[_0xa4ab[91]](_0xa4ab[92],function(_0x6937x2,_0x6937x3){_0x6937xa(_0x6937x3)}),$(_0xa4ab[93])[_0xa4ab[95]](_0xa4ab[94])&& $[_0xa4ab[99]]({type:_0xa4ab[96],url:_0xa4ab[97],dataType:_0xa4ab[98],success:function(_0x6937x2){_0x6937xa(_0x6937x2)}}),_0x6937x7[_0xa4ab[100]](_0xa4ab[76])}QuantityBreaks() } /* end-dbtfy-quantity-breaks */';

                // add js register
                $theme_js_content = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid'] ]
                )['body']['asset']['value'] ?? '';

                if( ( $pos = strpos( $theme_js_content , '/* start-register-quantity-breaks */' ) ) === false ) {
                    $new_theme_js = str_replace('var sections = new theme.Sections();', 'var sections = new theme.Sections(); /* start-register-quantity-breaks */sections.register("quantity-breaks", themeQuantityBreaks);/* end-register-quantity-breaks */', $theme_js_content);

                    $add_js = $shop->api()->request(
                        'PUT',
                        '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                        ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js] ]
                    );
                }

                $theme_js_content = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid'] ]
                )['body']['asset']['value'] ?? '';
                $replace_code= '/* start-dbtfy-addons */';
                if( ( $pos = strpos( $theme_js_content , '/* start-dbtfy-quantity-breaks */' ) ) === false ) {
                        $new_theme_js = str_replace($replace_code, $replace_code.$script, $theme_js_content);

                    $add_js = $shop->api()->request(
                        'PUT',
                        '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                        ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js] ]
                    );
                }
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('update js on quantity breaks addon throws client exception');
            }
            catch(\Exception $e){
                logger('update js on quantity breaks addon throws exception');
            }

        }
    }
}

// deactivate
if (! function_exists('deactivate_quantity_breaks_addon')) {
    function deactivate_quantity_breaks_addon($StoreThemes, $shop, $checkaddon) {
        foreach ($StoreThemes as $theme) {

            // remove scss
            $theme_style_content = $shop->api()->request(
                'GET',
                '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                ['asset' => ['key' => 'assets/theme.scss.liquid'] ]
            )['body'];

            if(!isset($theme_style_content['asset']['value']))
            {
              deactivate_quantity_breaks_addon_curl($theme, $shop);
              continue;
            }
            else
            {
              $content = $theme_style_content['asset']['value'] ?? '';
            }

            $quantitybreaks_Style = (string) '/* start-dbtfy-quantity-breaks */';
            $end = (string) '/* end-dbtfy-quantity-breaks */';
            $string = ' ' . $content;
            $ini = strpos($string, $quantitybreaks_Style);

            if ($ini == 0) {
              $parsed = '';
            }else{
              $ini += strlen($quantitybreaks_Style);
              $len = strpos($string, $end, $ini) - $ini;
              $parsed = substr($string, $ini, $len);
            }
            $values = $quantitybreaks_Style.''.$parsed.''.$end;

            if(str_contains($content,'dbtfy-quantity_breaks')){
                $value = str_replace($values, " ", $content);
                $new_theme_styles = (string) $value;

                $update_styles = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/theme.scss.liquid', 'value' => $new_theme_styles] ]
                );
            }

            // remove section
            $delete_quantitybreaks_section = $shop->api()->request(
              'DELETE',
              '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
              ['asset' => ['key' => 'sections/dbtfy-quantity-breaks.liquid'] ]
            );

            // remove include
            $product_template = $shop->api()->request(
                'GET',
                '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                ['asset' => ['key' => 'layout/theme.liquid'] ]
            )['body']['asset']['value'] ?? '';

            if(str_contains($product_template,'dbtfy-quantity-breaks')){
                $value  =  explode('{% section "dbtfy-quantity-breaks" %}',$product_template,2);
                if(isset($value[0]) && isset($value[1])){
                    $value = $value[0].' '.$value[1];
                }
                else{
                    $value = (string) $product_template;
                }
                $new_prod_template = (string) $value;
                $update_prod_template = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'layout/theme.liquid', 'value' => $new_prod_template] ]
                );
            }

            // remove js addon
            try{
               $theme_js_content = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid'] ]
                )['body']['asset']['value'] ?? '';

                $quantitybreaks_js = (string) '/* start-dbtfy-quantity-breaks */';
                $end_js = (string) '/* end-dbtfy-quantity-breaks */';
                $string_js = ' ' . $theme_js_content;
                $ini_js = strpos($string_js, $quantitybreaks_js);
                if ($ini_js == 0) {
                    $parsed_js = '';
                } else{
                    $ini_js += strlen($quantitybreaks_js);
                    $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
                    $parsed_js = substr($string_js, $ini_js, $len_js);
                }
                $value_js = $quantitybreaks_js.''.$parsed_js.''.$end_js;
                if(!empty($theme_js_content) && str_contains($theme_js_content,'/* start-dbtfy-quantity-breaks */')){
                    $value = str_replace($value_js, " ", $theme_js_content);
                    $new_theme_js = (string) $value;
                    if(str_contains($new_theme_js,'/* start-register-quantity-breaks */')){
                        $quantitybreaks_js1 = (string) '/* start-register-quantity-breaks */';
                        $end_js = (string) '/* end-register-quantity-breaks */';
                        $string_js = ' ' . $new_theme_js;
                        $ini_js = strpos($string_js, $quantitybreaks_js1);
                        if ($ini_js == 0) {
                            $parsed_js = '';
                        } else{
                            $ini_js += strlen($quantitybreaks_js1);
                            $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
                            $parsed_js = substr($string_js, $ini_js, $len_js);
                        }
                        $value_js = $quantitybreaks_js1.''.$parsed_js.''.$end_js;

                        $value = str_replace($value_js, " ", $new_theme_js);
                        $new_theme_js1 = (string) $value;
                        $update_js = $shop->api()->request(
                            'PUT',
                            '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                            ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js1] ]
                        );
                    }
                    else{
                        $update_js = $shop->api()->request(
                            'PUT',
                            '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                            ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js] ]
                        );
                    }
                }
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('remove quantity breaks throws client exception');
            }
            catch(\Exception $e){
                logger('remove quantity breaks throws exception');
            }

        }
    }
}


if (! function_exists('deactivate_quantity_breaks_addon_curl')) {
  function deactivate_quantity_breaks_addon_curl($theme, $shop) {

    // remove scss
    $theme_style_content = getThemeFileCurl($shop, $theme, 'assets/theme.scss.liquid') ?? '';

    $quantitybreaks_Style = (string) '/* start-dbtfy-quantity-breaks */';
    $end = (string) '/* end-dbtfy-quantity-breaks */';
    $string = ' ' . $theme_style_content;
    $ini = strpos($string, $quantitybreaks_Style);

    if ($ini == 0) {
      $parsed = '';
    }else{
      $ini += strlen($quantitybreaks_Style);
      $len = strpos($string, $end, $ini) - $ini;
      $parsed = substr($string, $ini, $len);
    }
    $values = $quantitybreaks_Style.''.$parsed.''.$end;

    if(str_contains($theme_style_content,'dbtfy-quantity_breaks')){
        $value = str_replace($values, " ", $theme_style_content);
        $new_theme_styles = (string) $value;

        $update_styles = putThemeFileCurl($shop, $theme, $new_theme_styles, 'assets/theme.scss.liquid');
    }

    // remove section
    $delete_quantitybreaks_section = deleteThemeFilesCurl($shop, $theme, 'sections/dbtfy-quantity-breaks.liquid');

    // remove include
    $theme_layout = getThemeFileCurl($shop, $theme, 'layout/theme.liquid') ?? '';

    if(str_contains($theme_layout,'dbtfy-quantity-breaks')){
        $value  =  explode('{% section "dbtfy-quantity-breaks" %}',$theme_layout,2);
        if(isset($value[0]) && isset($value[1])){
            $value = $value[0].' '.$value[1];
        }
        else{
            $value = (string) $theme_layout;
        }
        $new_theme_layout = (string) $value;
        $update_theme_layout = putThemeFileCurl($shop, $theme, $new_theme_layout, 'layout/theme.liquid');
    }

    // remove js addon
    try{
       $theme_js_content = getThemeFileCurl($shop, $theme, 'assets/dbtfy-addons.js.liquid') ?? '';

        $quantitybreaks_js = (string) '/* start-dbtfy-quantity-breaks */';
        $end_js = (string) '/* end-dbtfy-quantity-breaks */';
        $string_js = ' ' . $theme_js_content;
        $ini_js = strpos($string_js, $quantitybreaks_js);
        if ($ini_js == 0) {
            $parsed_js = '';
        } else{
            $ini_js += strlen($quantitybreaks_js);
            $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
            $parsed_js = substr($string_js, $ini_js, $len_js);
        }
        $value_js = $quantitybreaks_js.''.$parsed_js.''.$end_js;
        if(!empty($theme_js_content) && str_contains($theme_js_content,'/* start-dbtfy-quantity-breaks */')){
            $value = str_replace($value_js, " ", $theme_js_content);
            $new_theme_js = (string) $value;
            if(str_contains($new_theme_js,'/* start-register-quantity-breaks */')){
                $quantitybreaks_js1 = (string) '/* start-register-quantity-breaks */';
                $end_js = (string) '/* end-register-quantity-breaks */';
                $string_js = ' ' . $new_theme_js;
                $ini_js = strpos($string_js, $quantitybreaks_js1);
                if ($ini_js == 0) {
                    $parsed_js = '';
                } else{
                    $ini_js += strlen($quantitybreaks_js1);
                    $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
                    $parsed_js = substr($string_js, $ini_js, $len_js);
                }
                $value_js = $quantitybreaks_js1.''.$parsed_js.''.$end_js;

                $value = str_replace($value_js, " ", $new_theme_js);
                $new_theme_js1 = (string) $value;
                $update_js = putThemeFileCurl($shop, $theme, $new_theme_js1, 'assets/dbtfy-addons.js.liquid');
            }
            else{
                $update_js = putThemeFileCurl($shop, $theme, $new_theme_js, 'assets/dbtfy-addons.js.liquid');
            }
        }
    }
    catch(\GuzzleHttp\Exception\ClientException $e){
        logger('remove quantity breaks throws client exception');
    }
    catch(\Exception $e){
        logger('remove quantity breaks throws exception');
    }
  }
}
?>
