<?php
use Illuminate\Support\Arr;

//activate
if (! function_exists('activate_upsell_bundles_addon')) {
    function activate_upsell_bundles_addon($StoreThemes, $shop) {
      	foreach ($StoreThemes as $theme) {

            // add section
            try{
                $snippet = (string) '{%- comment -%}Please do not edit this file. Any modification can be lost as it is automatically updated by Debutify{%- endcomment -%}
{%- if section.settings.dbtfy_upsell_bundles -%}
{%- assign limit = section.settings.dbtfy_upsell_bundles_limit -%}
{%- assign specific_bundle = false -%}
{%- assign has_offer_1 = false -%}
{%- assign has_offer_2 = false -%}
{%- assign current_product = product -%}
{%- assign has_collection = true -%}
{%- assign grid_item_width = "large--two-twelfths medium--two-twelfths" -%}

{% for block in section.blocks %}
  {% assign product_trigger = block.settings.dbtfy_upsell_bundles_product_trigger %}

  {% if product_trigger == current_product.handle %}
    {% if block.settings.dbtfy_upsell_bundles_product_offer_1 != blank %}
      {% assign offer_1 = all_products[block.settings.dbtfy_upsell_bundles_product_offer_1] %}
	  {% assign has_offer_1 = true %}
    {% endif %}
    {% if block.settings.dbtfy_upsell_bundles_product_offer_2 != blank %}
      {% assign offer_2 = all_products[block.settings.dbtfy_upsell_bundles_product_offer_2] %}
      {% assign has_offer_2 = true %}
    {% endif %}
    {% assign specific_bundle = true %}
    {% break %}
  {% endif %}
{% endfor %}

{% if collections_count == 1 %}
  {% for collection in collections %}
    {% if collection.handle == "all" or collection.handle == "frontpage" %}
	  {% assign has_collection = false %}
	{% endif %}
  {% endfor %}
{% endif %}

{% if has_collection or specific_bundle %}
  {% include "dbtfy-upsell-bundles-grid" with current_product as product, type: "image", item: "first" %}
  {% include "dbtfy-upsell-bundles-grid" with current_product as product, type: "form", item: "first" %}
{% endif %}

<div id="UpsellBundles"
     data-product-id="{{ product.id }}"
     data-section-id="{{ section.id }}"
     data-section-type="bundle-recommendations"
     data-limit="{{ limit }}"
     data-position="{{section.settings.dbtfy_upsell_bundles_position}}"
     class="ub-position-{{section.settings.dbtfy_upsell_bundles_position}} {% if specific_bundle %}specific-upsell_bundles{% endif %}">
  {%- if recommendations.performed or specific_bundle -%}
  {%- if recommendations.products_count > 0 or specific_bundle -%}
    <div class="box">
      <div class="wrapper">

        {%- unless section.settings.dbtfy_upsell_bundles_title == blank and section.settings.dbtfy_upsell_bundles_subtitle == blank -%}
        <div class="section-header medium--text-left">
          <h2 class="section-header__title h3">{{ section.settings.dbtfy_upsell_bundles_title | escape }}</h2>
          <p class="section-header__subtitle">{{ section.settings.dbtfy_upsell_bundles_subtitle | escape }}</p>
        </div>
        {%- endunless -%}

        <div class="grid grid-uniform grid--spacer image-wrapper-upsell_bundles {% if section.settings.dbtfy_upsell_bundles_position == "button" %}grid--small{% endif %}">
          {% if specific_bundle %}
            {% if has_offer_1 %}
              {% include "dbtfy-upsell-bundles-grid" with offer_1 as product, type: "image" %}
            {% endif %}
            {% if has_offer_2 %}
              {% include "dbtfy-upsell-bundles-grid" with offer_2 as product, type: "image" %}
            {% endif %}
          {% else %}
            {%- for product in recommendations.products -%}
              {%- include "dbtfy-upsell-bundles-grid", type: "image" -%}
            {%- endfor -%}
          {% endif %}

          <div class="grid__item total-wrapper-upsell_bundles">
            <p>{{ section.settings.dbtfy_upsell_bundles_total }} <span class="total-upsell_bundles"></span></p>
            <button {% if section.settings.dbtfy_upsell_bundles_redirect %}data-href="/cart"{% else %}data-href="/checkout"{% endif %}
                    type="button" class="btn btn--buy btn-upsell_bundles">
              <div class="btn__text">
                {% unless section.settings.dbtfy_upsell_bundles_icon == blank %}
                <span class="fas fa-{{ section.settings.dbtfy_upsell_bundles_icon }}"></span>
                {% endunless %}
                {{ section.settings.dbtfy_upsell_bundles_cart }}
              </div>
            </button>
          </div>
        </div>

        <div class="form-wrapper-upsell_bundles">
          {% if specific_bundle %}
			{% if has_offer_1 %}
              {% include "dbtfy-upsell-bundles-grid" with offer_1 as product, type: "form" %}
            {% endif %}
            {% if has_offer_2 %}
              {% include "dbtfy-upsell-bundles-grid" with offer_2 as product, type: "form" %}
            {% endif %}
          {% else %}
            {%- for product in recommendations.products -%}
              {%- include "dbtfy-upsell-bundles-grid", type: "form" -%}
            {%- endfor -%}
          {% endif %}
        </div>

      </div>
    </div>
  {%- endif -%}
  {%- endif -%}
</div>
{%- endif -%}
';
$snippet_schema = (string) '
{% schema %}
  {
    "name": "Upsell bundles",
    "class": "dbtfy dbtfy-upsell_bundles",
    "settings": [
      {
        "type": "header",
        "content": "Activation"
      },
      {
        "type": "checkbox",
        "id": "dbtfy_upsell_bundles",
        "label": "Activate",
		"info": "Dynamic recommendations change and improve with time. [Learn more](https://help.shopify.com/en/themes/development/recommended-products)",
        "default": false
      },
      {
        "type": "paragraph",
        "content": "* Create at least 1 collection to show dynamic recommendations or use specific bundles below"
      },
      {
        "type": "header",
        "content": "Text settings"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_bundles_title",
        "label": "Heading",
        "default": "Frequently bought togheter"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_bundles_subtitle",
        "label": "Subheading"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_bundles_total",
        "label": "Total",
        "default": "Total price:"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_bundles_icon",
        "label": "Cart icon",
        "default": "cart-plus",
        "info": "Enter the name of any free solid icons on [FontAwesome](https:\/\/fontawesome.com\/icons?d=gallery&s=solid&m=free)"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_bundles_cart",
        "label": "Add-to-cart button",
        "default": "Add selected items"
      },
      {
        "type": "text",
        "id": "dbtfy_upsell_bundles_current",
        "label": "Current product",
        "default": "This item:"
      },
	  {
        "type": "header",
        "content": "Bundle settings"
      },
      {
        "type": "checkbox",
        "id": "dbtfy_upsell_bundles_redirect",
        "label": "Redirect to cart",
        "info": "Default redirects to checkout"
      },
      {
        "type": "checkbox",
        "id": "dbtfy_upsell_bundles_reviews",
        "label": "Show star ratings",
        "default": false
      },
      {
        "type": "select",
        "id": "dbtfy_upsell_bundles_limit",
        "label": "Products upsell",
		"default": "2",
        "options": [
          {
            "value": "1",
            "label": "1"
          },
          {
            "value": "2",
            "label": "2"
          }
        ]
      },
      {
        "type": "select",
        "id": "dbtfy_upsell_bundles_position",
        "label": "Position",
		"default": "product",
        "options": [
          {
            "value": "product",
            "label": "Under product section"
          },
          {
            "value": "button",
            "label": "Under add-to-cart button"
          }
        ]
      }
    ],
	"blocks" : [
      {
        "type": "bundle",
        "name": "Specific bundle",
        "settings": [
          {
            "type": "product",
            "id": "dbtfy_upsell_bundles_product_trigger",
            "label": "Product trigger"
          },
          {
            "type": "product",
            "id": "dbtfy_upsell_bundles_product_offer_1",
            "label": "Product offer"
          },
          {
            "type": "product",
            "id": "dbtfy_upsell_bundles_product_offer_2",
            "label": "Product offer"
          }
		]
      }
    ]
  }
{% endschema %}';

                $snippet = addScriptTagCondition($shop, '{%- comment -%}Please do not edit this file. Any modification can be lost as it is automatically updated by Debutify{%- endcomment -%}', $snippet);

                $snippet .= $snippet_schema;

                $create_upsellbundles_snippet = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'sections/dbtfy-upsell-bundles.liquid', 'value' => $snippet] ]
                );
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('add upsellBundles throws client exception');
            }
            catch(\Exception $e){
                logger('add upsellBundles throws exception');
            }

            // add dbtfy-upsell-bundles-grid snippet
            try{
              $upsell_bundles_grid_snippet = (string) '{%- comment -%}Please do not edit this file. Any modification can be lost as it is automatically updated by Debutify{%- endcomment -%}
              {% assign on_sale = false %}
{% if product.compare_at_price > product.price %}
  {% assign on_sale = true %}
{% endif %}

{% assign sold_out = true %}
{% if product.available %}
  {% assign sold_out = false %}
{% endif %}

{%- assign variant = product.selected_or_first_available_variant -%}
{%- assign product_link = product.url | within: collection -%}

{% unless sold_out %}

{% if type == "image" %}
<div class="grid__item {{ grid_item_width }} image-item-upsell_bundles selected-image-upsell_bundles grid-image-{{ product.id }} {% if item == "first" %}current-image-upsell_bundles{% endif %}">

  {%- assign loop = 0 -%}

  {% unless product.has_only_default_variant %}
    {% for variant in product.variants %}
      {% if variant.available %}
        {%- assign loop = loop | plus: 1 -%}
        {% if variant.image %}
          {%- assign image = variant.image -%}
        {% else %}
          {%- assign image = product.featured_image -%}
        {% endif %}
        {%- assign img_url = image | img_url: "1x1" | replace: "_1x1.", "_{width}x." -%}
  		<a id="imageUpsellBundles-{{ variant.id }}" class="loop-{{loop}} grid-product__image-link image-link image-link-upsell_bundles" {% unless item == "first" %}href="{{ product_link }}"{% endunless %}  style="{% unless loop == 1 %}display:none;{% endunless %}">
          <div class="product--wrapper image-wrapper">
            <div style="padding-top:{{ 1 | divided_by: image.aspect_ratio | times: 100 }}%;">
              <img class="product--image image lazyload"
                   src="{{ image | img_url: "small" }}"
                   data-src="{{ img_url }}"
                   data-widths="[180, 370, 590, 740, 900, 1080, 1296, 1512, 1728, 2048]"
                   data-aspectratio="{{ image.aspect_ratio }}"
                   data-sizes="auto"
                   alt="{{ image.alt | escape }}"
                   data-image>
            </div>
          </div>
        </a>
      {% endif %}
    {% endfor %}
  {% else %}
    {%- assign loop = 1 -%}
    {%- assign image = product.featured_image -%}
    {%- assign img_url = image | img_url: "1x1" | replace: "_1x1.", "_{width}x." -%}
    <a id="imageUpsellBundles-{{ variant.id }}" class="loop-{{loop}} grid-product__image-link image-link image-link-upsell_bundles" {% unless item == "first" %}href="{{ product_link }}"{% endunless %}  style="{% unless loop == 1 %}display:none;{% endunless %}">
      <div class="product--wrapper image-wrapper">
        <div style="padding-top:{{ 1 | divided_by: image.aspect_ratio | times: 100 }}%;">
          <img class="product--image image lazyload"
               src="{{ image | img_url: "small" }}"
               data-src="{{ img_url }}"
               data-widths="[180, 370, 590, 740, 900, 1080, 1296, 1512, 1728, 2048]"
               data-aspectratio="{{ image.aspect_ratio }}"
               data-sizes="auto"
               alt="{{ image.alt | escape }}"
               data-image>
        </div>
      </div>
    </a>
  {% endunless %}

</div>
{% endif %}


{% if type == "form" %}
<div class="form-item-upsell_bundles {% if item == "first" %}current-form-upsell_bundles{% endif %}">

  <label for="upsellBundleCheckbox-{{ product.id }}" class="label-upsell_bundles">
    <input id="upsellBundleCheckbox-{{ product.id }}" class="checkbox-upsell_bundles" data-product-id="{{ product.id }} " type="checkbox" value="{{ product.id }}" checked>
    {% if item == "first" %}
    <strong>{{ section.settings.dbtfy_upsell_bundles_current }}</strong>
    {% endif %}
    <span class="title-upsell_bundles">{{ product.title }}</span>
    {% if section.settings.dbtfy_upsell_bundles_reviews %}
      {% include "review-badge", badge_template: "grid" %}
    {% endif %}
  </label>

  <form data-id="{{product.id}}" id="upsellBundles-{{product.id}}" autocomplete="off" action="/cart/add" method="post" class="form-upsell_bundles active-upsell_bundles" enctype="multipart/form-data">
    <select class="select--small select-upsell_bundles" name="id">
      {% unless product.has_only_default_variant %}
        {% for variant in product.variants %}
          {% if variant.available %}
            <option {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %} value="{{ variant.id }}" data-price="{{ variant.price }}">
              {{ variant.title | escape }} - {{ variant.price | money }}
            </option>
          {% endif %}
        {% endfor %}
      {% else %}
      <option {% if variant == product.selected_or_first_available_variant %}selected="selected"{% endif %} value="{{ variant.id }}" data-price="{{ variant.price }}">
        {{ product.title | escape }} - {{ variant.price | money }}
      </option>
      {% endunless %}
    </select>
  </form>

</div>
{% endif %}

{% endunless %}';

                $upsell_bundles_grid_snippet = addScriptTagCondition($shop, '{%- comment -%}Please do not edit this file. Any modification can be lost as it is automatically updated by Debutify{%- endcomment -%}', $upsell_bundles_grid_snippet);
              $create_bundles_grid_snippet = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'snippets/dbtfy-upsell-bundles-grid.liquid', 'value' => $upsell_bundles_grid_snippet] ]
                );
            }catch(\GuzzleHttp\Exception\ClientException $e){
                logger('add upsell bundles grid throws client exception');
            }
            catch(\Exception $e){
                logger('add upsell bundles grid throws exception');
            }

            // add scss
            try{
                $styles = (string) '/* start-dbtfy-upsell-bundles */.dbtfy-upsell_bundles{.box{padding-top:0}.image-wrapper-upsell_bundles{@include align-items(center)}.image-item-upsell_bundles{& + .image-item-upsell_bundles{position:relative;&:before{opacity:$opacity-link-hover/2;@include fontAwesome;content:"\f055";color:$colorSecondary;position:absolute;left:0;height:100%;width:$gutter;@include display-flexbox();@include align-items(center);@include justify-content(center);@include transition($transitions)}}&.selected-image-upsell_bundles:before{opacity:1}}.image-link-upsell_bundles{opacity:$opacity-link-hover/2}.selected-image-upsell_bundles .image-link-upsell_bundles{opacity:1;@include hovers}.form-wrapper-upsell_bundles{margin-top:$spacer}.form-item-upsell_bundles{@include display-flexbox();@include align-items(center);& + .form-item-upsell_bundles{margin-top:$spacer-sm}}.label-upsell_bundles{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:50%;@include flex-shrink(0)}.current-form-upsell_bundles .label-upsell_bundles{cursor:default;&:hover{opacity:1}}.form-upsell_bundles{margin-left:$spacer-sm}.fill-item-upsell_bundles{@include flex(auto);width:auto}.total-upsell_bundles{@include accentFontStack;font-size:$baseFontSize-lg}.review-badge{display:inline-block;margin-left:$spacer-sm}.ub-position-product{@include screenUp($small){.section-header{text-align:left}.total-wrapper-upsell_bundles{width:auto}}}@mixin mobileStyle{.image-item-upsell_bundles{@include flex(1);& + .image-item-upsell_bundles{&:before{left:0;font-size:$baseFontSize-sm;width:$gutter-sm}}}.btn-upsell_bundles{width:100%}.select-upsell_bundles{width:100%}.form-upsell_bundles{@include flex(auto)}.total-wrapper-upsell_bundles{width:100%;text-align:center}.review-badge{display:none}}.ub-position-button{@include mobileStyle;margin-bottom:$spacer;.wrapper,.box{padding:0}}@include screen($small){@include mobileStyle}}/* end-dbtfy-upsell-bundles */';

                $theme_style_content = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/theme.scss.liquid'] ]
                )['body']['asset']['value'] ?? '';

                if( ( $pos = strpos( $theme_style_content , 'start-dbtfy-upsell-bundles' ) ) === false ) {
                    $new_theme_styles = str_replace($theme_style_content, $theme_style_content.$styles, $theme_style_content);
                    $add_styles = $shop->api()->request(
                        'PUT',
                        '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                        ['asset' => ['key' => 'assets/theme.scss.liquid', 'value' => $new_theme_styles] ]
                    );
                }
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('update CSS on upsell_bundles addon throws client exception');
            }
            catch(\Exception $e){
                logger('update CSS on upsell_bundles addon throws exception');
            }

            // add include
            try{
                $product_template = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'templates/product.liquid'] ]
                )['body']['asset']['value'] ?? '';

                if( ( $pos = strpos( $product_template , 'dbtfy-upsell-bundles' ) ) === false ) {
                    if( ( $pos = strrpos( $product_template , "{% section 'product-template' %}" ) ) !== false ) {
                        $new_prod_template = str_replace("{% section 'product-template' %}", '{% section \'product-template\' %}{% section "dbtfy-upsell-bundles" %}', $product_template);
                        $update_prod_template = $shop->api()->request(
                            'PUT',
                            '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                            ['asset' => ['key' => 'templates/product.liquid', 'value' => $new_prod_template] ]
                        );
                    }
                }
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('update upsell_bundles on upsell_bundles addon throws client exception');
            }
            catch(\Exception $e){
                logger('update upsell_bundles on upsell_bundles addon throws exception');
            }

             // add js addon
            try{
              $script= (string)'/* start-dbtfy-upsell-bundles */ function themeUpsellBundles(){ var _0xedd0=["\x2E\x64\x62\x74\x66\x79\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x23\x55\x70\x73\x65\x6C\x6C\x42\x75\x6E\x64\x6C\x65\x73","\x70\x6F\x73\x69\x74\x69\x6F\x6E","\x64\x61\x74\x61","\x2F\x72\x65\x63\x6F\x6D\x6D\x65\x6E\x64\x61\x74\x69\x6F\x6E\x73\x2F\x70\x72\x6F\x64\x75\x63\x74\x73\x3F\x26\x73\x65\x63\x74\x69\x6F\x6E\x5F\x69\x64\x3D","\x73\x65\x63\x74\x69\x6F\x6E\x49\x64","\x26\x70\x72\x6F\x64\x75\x63\x74\x5F\x69\x64\x3D","\x70\x72\x6F\x64\x75\x63\x74\x49\x64","\x26\x6C\x69\x6D\x69\x74\x3D","\x6C\x69\x6D\x69\x74","\x2E\x62\x74\x6E\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x2E\x73\x65\x6C\x65\x63\x74\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x68\x72\x65\x66","\x2E\x74\x6F\x74\x61\x6C\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x3A\x63\x68\x65\x63\x6B\x65\x64","\x69\x73","\x2E\x63\x68\x65\x63\x6B\x62\x6F\x78\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x66\x69\x6E\x64","\x2E\x66\x6F\x72\x6D\x2D\x69\x74\x65\x6D\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x63\x6C\x6F\x73\x65\x73\x74","\x70\x72\x69\x63\x65","\x6F\x70\x74\x69\x6F\x6E\x3A\x73\x65\x6C\x65\x63\x74\x65\x64","\x63\x68\x69\x6C\x64\x72\x65\x6E","\x65\x61\x63\x68","\x6D\x6F\x6E\x65\x79\x46\x6F\x72\x6D\x61\x74","\x73\x74\x72\x69\x6E\x67\x73","\x66\x6F\x72\x6D\x61\x74\x4D\x6F\x6E\x65\x79","\x43\x75\x72\x72\x65\x6E\x63\x79","\x68\x74\x6D\x6C","\x74\x6F\x74\x61\x6C","\x2E\x69\x6D\x61\x67\x65\x2D\x77\x72\x61\x70\x70\x65\x72\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x70\x72\x65\x70\x65\x6E\x64\x54\x6F","\x2E\x63\x75\x72\x72\x65\x6E\x74\x2D\x69\x6D\x61\x67\x65\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x2E\x66\x6F\x72\x6D\x2D\x77\x72\x61\x70\x70\x65\x72\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x2E\x63\x75\x72\x72\x65\x6E\x74\x2D\x66\x6F\x72\x6D\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x62\x75\x74\x74\x6F\x6E","\x6C\x65\x6E\x67\x74\x68","\x2E\x64\x62\x74\x66\x79\x2D\x74\x72\x75\x73\x74\x5F\x62\x61\x64\x67\x65","\x69\x6E\x73\x65\x72\x74\x41\x66\x74\x65\x72","\x2E\x64\x62\x74\x66\x79\x2D\x73\x61\x6C\x65\x73\x5F\x63\x6F\x75\x6E\x74\x64\x6F\x77\x6E","\x5B\x69\x74\x65\x6D\x70\x72\x6F\x70\x3D\x27\x6F\x66\x66\x65\x72\x73\x27\x5D","\x63\x6C\x69\x63\x6B","\x2E\x67\x72\x69\x64\x2D\x69\x6D\x61\x67\x65\x2D","\x23\x75\x70\x73\x65\x6C\x6C\x42\x75\x6E\x64\x6C\x65\x73\x2D","\x2E\x73\x65\x6C\x65\x63\x74\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73\x20\x6F\x70\x74\x69\x6F\x6E\x3A\x73\x65\x6C\x65\x63\x74\x65\x64","\x73\x65\x6C\x65\x63\x74\x65\x64\x2D\x69\x6D\x61\x67\x65\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x61\x64\x64\x43\x6C\x61\x73\x73","\x61\x63\x74\x69\x76\x65\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x72\x65\x6D\x6F\x76\x65\x43\x6C\x61\x73\x73","\x6F\x6E","\x63\x68\x61\x6E\x67\x65","\x76\x61\x6C","\x23\x69\x6D\x61\x67\x65\x55\x70\x73\x65\x6C\x6C\x42\x75\x6E\x64\x6C\x65\x73\x2D","\x68\x69\x64\x65","\x73\x69\x62\x6C\x69\x6E\x67\x73","\x73\x68\x6F\x77","\x72\x65\x61\x64\x79","\x6F\x75\x74\x65\x72\x57\x69\x64\x74\x68","\x6D\x69\x6E\x2D\x77\x69\x64\x74\x68","\x63\x73\x73","\x62\x74\x6E\x2D\x2D\x6C\x6F\x61\x64\x69\x6E\x67","\x69\x64","\x70\x75\x73\x68","\x2E\x66\x6F\x72\x6D\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73\x2E\x61\x63\x74\x69\x76\x65\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x73\x68\x69\x66\x74","\x50\x4F\x53\x54","\x2F\x63\x61\x72\x74\x2F\x61\x64\x64\x2E\x6A\x73","\x73\x65\x72\x69\x61\x6C\x69\x7A\x65","\x6A\x73\x6F\x6E","\x61\x73\x73\x69\x67\x6E","\x6C\x6F\x63\x61\x74\x69\x6F\x6E","\x61\x6A\x61\x78","\x73\x70\x65\x63\x69\x66\x69\x63\x2D\x75\x70\x73\x65\x6C\x6C\x5F\x62\x75\x6E\x64\x6C\x65\x73","\x68\x61\x73\x43\x6C\x61\x73\x73","","\x74\x72\x69\x6D","\x74\x68\x65\x6E","\x67\x65\x74"];function UpsellBundles(){var _0x21a8x2=$(_0xedd0[0]),_0x21a8x3=$(_0xedd0[1]),_0x21a8x4=_0x21a8x3[_0xedd0[3]](_0xedd0[2]),_0x21a8x5=_0xedd0[4]+ _0x21a8x3[_0xedd0[3]](_0xedd0[5])+ _0xedd0[6]+ _0x21a8x3[_0xedd0[3]](_0xedd0[7])+ _0xedd0[8]+ _0x21a8x3[_0xedd0[3]](_0xedd0[9]);function _0x21a8x6(){var _0x21a8x5=$(_0xedd0[10]),_0x21a8x3=$(_0xedd0[11]),_0x21a8x6=_0x21a8x5[_0xedd0[3]](_0xedd0[12]),_0x21a8x7=$(_0xedd0[13]);function _0x21a8x8(){var _0x21a8x5=0;_0x21a8x3[_0xedd0[23]](function(){$(this)[_0xedd0[19]](_0xedd0[18])[_0xedd0[17]](_0xedd0[16])[_0xedd0[15]](_0xedd0[14])?_0x21a8x5+= parseInt($(this)[_0xedd0[22]](_0xedd0[21])[_0xedd0[3]](_0xedd0[20])):_0x21a8x5+= parseInt(0)});var _0x21a8x2=theme[_0xedd0[25]][_0xedd0[24]];_0x21a8x7[_0xedd0[3]](_0xedd0[29],_0x21a8x5)[_0xedd0[28]](theme[_0xedd0[27]][_0xedd0[26]](_0x21a8x5,_0x21a8x2))}$(_0xedd0[32])[_0xedd0[31]](_0xedd0[30]),$(_0xedd0[34])[_0xedd0[31]](_0xedd0[33]),_0xedd0[35]== _0x21a8x4&& ($(_0xedd0[37])[_0xedd0[36]]?_0x21a8x2[_0xedd0[38]](_0xedd0[37]):$(_0xedd0[39])[_0xedd0[36]]?_0x21a8x2[_0xedd0[38]](_0xedd0[39]):_0x21a8x2[_0xedd0[38]](_0xedd0[40])),$(_0xedd0[16])[_0xedd0[49]](_0xedd0[41],function(){var _0x21a8x5=$(this),_0x21a8x2=_0x21a8x5[_0xedd0[3]](_0xedd0[7]),_0x21a8x3=$(_0xedd0[42]+ _0x21a8x2),_0x21a8x4=$(_0xedd0[43]+ _0x21a8x2),_0x21a8x6=_0x21a8x4[_0xedd0[17]](_0xedd0[44])[_0xedd0[3]](_0xedd0[20]),_0x21a8x9=_0x21a8x7[_0xedd0[3]](_0xedd0[29]);if(_0x21a8x5[_0xedd0[15]](_0xedd0[14])){_0x21a8x3[_0xedd0[46]](_0xedd0[45]),_0x21a8x4[_0xedd0[46]](_0xedd0[47]),_0x21a8x8()}else {_0x21a8x3[_0xedd0[48]](_0xedd0[45]),_0x21a8x4[_0xedd0[48]](_0xedd0[47]);var _0x21a8xa=_0x21a8x9- _0x21a8x6,_0x21a8xb=theme[_0xedd0[25]][_0xedd0[24]];_0x21a8x7[_0xedd0[3]](_0xedd0[29],_0x21a8xa)[_0xedd0[28]](theme[_0xedd0[27]][_0xedd0[26]](_0x21a8xa,_0x21a8xb))}}),_0x21a8x3[_0xedd0[49]](_0xedd0[50],function(){var _0x21a8x5=$(this)[_0xedd0[51]](),_0x21a8x2=$(_0xedd0[52]+ _0x21a8x5);_0x21a8x2[_0xedd0[54]]()[_0xedd0[53]](),_0x21a8x2[_0xedd0[55]](),_0x21a8x8()}),$(document)[_0xedd0[56]](function(){_0x21a8x8()}),_0x21a8x5[_0xedd0[49]](_0xedd0[41],function(){var _0x21a8x5=$(this)[_0xedd0[57]](),_0x21a8x2=[];$(this)[_0xedd0[59]](_0xedd0[58],_0x21a8x5),$(this)[_0xedd0[46]](_0xedd0[60]),$(_0xedd0[63])[_0xedd0[23]](function(){var _0x21a8x5=$(this)[_0xedd0[3]](_0xedd0[61]);_0x21a8x2[_0xedd0[62]](_0x21a8x5)}),function _0x21a8x2(_0x21a8x3){var _0x21a8x5=_0x21a8x3[_0xedd0[64]](),_0x21a8x4=$(_0xedd0[43]+ _0x21a8x5);$[_0xedd0[71]]({type:_0xedd0[65],url:_0xedd0[66],data:$(_0x21a8x4)[_0xedd0[67]](),dataType:_0xedd0[68],success:function(_0x21a8x5){setTimeout(function(){0== _0x21a8x3[_0xedd0[36]]?window[_0xedd0[70]][_0xedd0[69]](_0x21a8x6):_0x21a8x2(_0x21a8x3)},150)}})}(_0x21a8x2)})}_0x21a8x3[_0xedd0[73]](_0xedd0[72])?_0x21a8x6():$[_0xedd0[77]](_0x21a8x5)[_0xedd0[76]](function(_0x21a8x5){var _0x21a8x2=$(_0x21a8x5)[_0xedd0[17]](_0xedd0[1])[_0xedd0[28]]();_0xedd0[74]!== _0x21a8x2[_0xedd0[75]]()&& (_0x21a8x3[_0xedd0[28]](_0x21a8x2),_0x21a8x6())})}UpsellBundles() }; /* end-dbtfy-upsell-bundles */';

                // add js register
                $theme_js_content = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid'] ]
                )['body']['asset']['value'] ?? '';

                if( ( $pos = strpos( $theme_js_content , "/* start-register-upsell-bundles */" ) ) === false ) {
                    $new_theme_js = str_replace('var sections = new theme.Sections();','var sections = new theme.Sections();/* start-register-upsell-bundles */sections.register("bundle-recommendations", themeUpsellBundles);/* end-register-upsell-bundles */', $theme_js_content);

                    $add_js = $shop->api()->request(
                        'PUT',
                        '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                        ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js] ]
                    );
                }

                $theme_js_content = $shop->api()->request(
                    'GET',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid'] ]
                )['body']['asset']['value'] ?? '';
                $replace_code= '/* start-dbtfy-addons */';
                if( ( $pos = strpos( $theme_js_content , '/* start-dbtfy-upsell-bundles */' ) ) === false ) {
                        $new_theme_js = str_replace($replace_code, $replace_code.$script, $theme_js_content);

                    $add_js = $shop->api()->request(
                        'PUT',
                        '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                        ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js] ]
                    );
                }
            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('update js on cookie_box addon throws client exception');
            }
            catch(\Exception $e){
                logger('update js on cookie_box addon throws exception');
            }

        }
    }
}

// deactivate
if (! function_exists('deactivate_upsell_bundles_addon')) {
    function deactivate_upsell_bundles_addon($StoreThemes, $shop, $checkaddon) {
        foreach ($StoreThemes as $theme) {

            // remove scss
            $theme_style_content = $shop->api()->request(
                'GET',
                '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                ['asset' => ['key' => 'assets/theme.scss.liquid'] ]
            )['body'];

            if(!isset($theme_style_content['asset']['value']))
            {
              deactivate_upsell_bundles_addon_curl($theme, $shop);
              continue;
            }
            else
            {
              $content = $theme_style_content['asset']['value'] ?? '';
            }

            $upsellbundles_Style = (string) '/* start-dbtfy-upsell-bundles */';
            $end = (string) '/* end-dbtfy-upsell-bundles */';
            $string = ' ' . $content;
            $ini = strpos($string, $upsellbundles_Style);

            if ($ini == 0) {
              $parsed = '';
            }else{
              $ini += strlen($upsellbundles_Style);
              $len = strpos($string, $end, $ini) - $ini;
              $parsed = substr($string, $ini, $len);
            }
            $values = $upsellbundles_Style.''.$parsed.''.$end;

            if(str_contains($content,'dbtfy-upsell_bundles')){
                $value = str_replace($values, " ", $content);
                $new_theme_styles = (string) $value;

                $update_styles = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/theme.scss.liquid', 'value' => $new_theme_styles] ]
                );
            }

            //remove snippet
            $delete_upsellbundles_snippet = $shop->api()->request(
              'DELETE',
              '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
              ['asset' => ['key' => 'sections/dbtfy-upsell-bundles.liquid'] ]
            );

            //remove snippet
            $delete_upsell_bundles_grid = $shop->api()->request(
              'DELETE',
              '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
              ['asset' => ['key' => 'snippets/dbtfy-upsell-bundles-grid.liquid'] ]
            );

            // remove include
            $product_template = $shop->api()->request(
                'GET',
                '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                ['asset' => ['key' => 'templates/product.liquid'] ]
            )['body']['asset']['value'] ?? '';

            if(str_contains($product_template,'dbtfy-upsell-bundles')){
                $value  =  explode('{% section "dbtfy-upsell-bundles" %}',$product_template,2);

                if(isset($value[0]) && isset($value[1])){
                    $value = $value[0].' '.$value[1];
                }
                else{
                    $value = (string) $product_template;
                }

                $new_prod_template = (string) $value;
                $update_prod_template = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'templates/product.liquid', 'value' => $new_prod_template] ]
                );
            }

            // remove js
            try{
              $theme_js_content = $shop->api()->request(
                  'GET',
                  '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                  ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid'] ]
              )['body']['asset']['value'] ?? '';

              $upsellbundles_js = (string) '/* start-dbtfy-upsell-bundles */';
              $end_js = (string) '/* end-dbtfy-upsell-bundles */';
              $string_js = ' ' . $theme_js_content;
              $ini_js = strpos($string_js, $upsellbundles_js);
              if ($ini_js == 0) {
                  $parsed_js = '';
              }else{
                  $ini_js += strlen($upsellbundles_js);
                  $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
                  $parsed_js = substr($string_js, $ini_js, $len_js);
              }
              $value_js = $upsellbundles_js.''.$parsed_js.''.$end_js;
              if(!empty($theme_js_content) && str_contains($theme_js_content,'/* start-dbtfy-upsell-bundles */')){
                $value = str_replace($value_js, " ", $theme_js_content);
                $new_theme_js = (string) $value;

                if(str_contains($new_theme_js,'/* start-register-upsell-bundles */')){
                  $upsellbundles_js1 = (string) '/* start-register-upsell-bundles */';
                  $end_js = (string) '/* end-register-upsell-bundles */';
                  $string_js = ' ' . $new_theme_js;
                  $ini_js = strpos($string_js, $upsellbundles_js1);
                  if ($ini_js == 0) {
                      $parsed_js = '';
                  }else{
                      $ini_js += strlen($upsellbundles_js1);
                      $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
                      $parsed_js = substr($string_js, $ini_js, $len_js);
                  }
                  $value_js = $upsellbundles_js1.''.$parsed_js.''.$end_js;

                  $value = str_replace($value_js, " ", $new_theme_js);
                  $new_theme_js1 = (string) $value;
                  $update_js = $shop->api()->request(
                      'PUT',
                      '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                      ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js1] ]
                  );
                }else{
                  $update_js = $shop->api()->request(
                    'PUT',
                    '/admin/api/themes/'.$theme->shopify_theme_id.'/assets.json',
                    ['asset' => ['key' => 'assets/dbtfy-addons.js.liquid', 'value' => $new_theme_js] ]
                  );
                }
              }

            }
            catch(\GuzzleHttp\Exception\ClientException $e){
                logger('add upsell_bundles throws client exception');
            }
            catch(\Exception $e){
                logger('add upsell_bundles throws exception');
            }
        }
    }
}



if (! function_exists('deactivate_upsell_bundles_addon_curl')) {
  function deactivate_upsell_bundles_addon_curl($theme, $shop) {

    // remove scss
    $theme_style_content = getThemeFileCurl($shop, $theme, 'assets/theme.scss.liquid') ?? '';

    $upsellbundles_Style = (string) '/* start-dbtfy-upsell-bundles */';
    $end = (string) '/* end-dbtfy-upsell-bundles */';
    $string = ' ' . $theme_style_content;
    $ini = strpos($string, $upsellbundles_Style);

    if ($ini == 0) {
      $parsed = '';
    }else{
      $ini += strlen($upsellbundles_Style);
      $len = strpos($string, $end, $ini) - $ini;
      $parsed = substr($string, $ini, $len);
    }
    $values = $upsellbundles_Style.''.$parsed.''.$end;

    if(str_contains($theme_style_content,'dbtfy-upsell_bundles')){
        $value = str_replace($values, " ", $theme_style_content);
        $new_theme_styles = (string) $value;

        $update_styles = putThemeFileCurl($shop, $theme, $new_theme_styles, 'assets/theme.scss.liquid');
    }

    //remove snippet
    $delete_upsellbundles_snippet = deleteThemeFilesCurl($shop, $theme, 'sections/dbtfy-upsell-bundles.liquid');

    //remove snippet
    $delete_upsell_bundles_grid = deleteThemeFilesCurl($shop, $theme, 'snippets/dbtfy-upsell-bundles-grid.liquid');

    // remove include
    $product_template = getThemeFileCurl($shop, $theme, 'templates/product.liquid');

    if(str_contains($product_template,'dbtfy-upsell-bundles')){
        $value  =  explode('{% section "dbtfy-upsell-bundles" %}',$product_template,2);

        if(isset($value[0]) && isset($value[1])){
            $value = $value[0].' '.$value[1];
        }
        else{
            $value = (string) $product_template;
        }

        $new_prod_template = (string) $value;
        $update_prod_template = putThemeFileCurl($shop, $theme, $new_prod_template, 'templates/product.liquid');
    }

    // remove js
    try{
      $theme_js_content = getThemeFileCurl($shop, $theme, 'assets/dbtfy-addons.js.liquid') ?? '';

      $upsellbundles_js = (string) '/* start-dbtfy-upsell-bundles */';
      $end_js = (string) '/* end-dbtfy-upsell-bundles */';
      $string_js = ' ' . $theme_js_content;
      $ini_js = strpos($string_js, $upsellbundles_js);
      if ($ini_js == 0) {
          $parsed_js = '';
      }else{
          $ini_js += strlen($upsellbundles_js);
          $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
          $parsed_js = substr($string_js, $ini_js, $len_js);
      }
      $value_js = $upsellbundles_js.''.$parsed_js.''.$end_js;
      if(!empty($theme_js_content) && str_contains($theme_js_content,'/* start-dbtfy-upsell-bundles */')){
        $value = str_replace($value_js, " ", $theme_js_content);
        $new_theme_js = (string) $value;

        if(str_contains($new_theme_js,'/* start-register-upsell-bundles */')){
          $upsellbundles_js1 = (string) '/* start-register-upsell-bundles */';
          $end_js = (string) '/* end-register-upsell-bundles */';
          $string_js = ' ' . $new_theme_js;
          $ini_js = strpos($string_js, $upsellbundles_js1);
          if ($ini_js == 0) {
              $parsed_js = '';
          }else{
              $ini_js += strlen($upsellbundles_js1);
              $len_js = strpos($string_js, $end_js, $ini_js) - $ini_js;
              $parsed_js = substr($string_js, $ini_js, $len_js);
          }
          $value_js = $upsellbundles_js1.''.$parsed_js.''.$end_js;

          $value = str_replace($value_js, " ", $new_theme_js);
          $new_theme_js1 = (string) $value;
          $update_js = putThemeFileCurl($shop, $theme, $new_theme_js1, 'assets/dbtfy-addons.js.liquid');
        }else{
          $update_js = putThemeFileCurl($shop, $theme, $new_theme_js, 'assets/dbtfy-addons.js.liquid');
        }
      }

    }
    catch(\GuzzleHttp\Exception\ClientException $e){
        logger('add upsell_bundles throws client exception');
    }
    catch(\Exception $e){
        logger('add upsell_bundles throws exception');
    }
  }
}
?>
